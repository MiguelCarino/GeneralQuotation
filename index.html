<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurable Quoting Tool</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/23.2.3/i18next.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/7.1.0/i18nextBrowserLanguageDetector.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Red+Hat+Text:ital,wght@0,300..700;1,300..700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Default Colors - overwritten by JSON */
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --bg-nav: #61bad2;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; margin: 0; background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; transition: background-color 0.3s; }

        /* Navbar */
        .navbar {
            background-color: var(--bg-nav); border-bottom: 1px solid var(--border); 
            padding: 0 24px; height: 60px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand-link { text-decoration: none; color: inherit; display: flex; align-items: center; gap: 12px; transition: opacity 0.2s; }
        .brand-link:hover { opacity: 0.8; }
        .nav-logo { height: 32px; width: auto; border-radius: 4px; }
        .brand-text { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }

        /* Language Switcher */
        .lang-switch { display: flex; background: #f8fafc; padding: 3px; border-radius: 6px; border: 1px solid var(--border); }
        .lang-btn {
            background: transparent; border: none; padding: 4px 12px; font-size: 0.8rem; 
            font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 4px;
        }
        .lang-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Main Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar {
            width: 380px; background: var(--bg-surface); border-right: 1px solid var(--border);
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
        }

        /* Dropzone */
        .dropzone {
            border: 2px dashed var(--border); border-radius: 8px; padding: 20px;
            text-align: center; cursor: pointer; transition: all 0.2s; background: #f8fafc;
        }
        .dropzone:hover, .dropzone.dragover { border-color: var(--primary); background: #eff6ff; }
        .dropzone.success { border-color: var(--success); background: #ecfdf5; }
        .dropzone p { margin: 0; font-size: 0.85rem; color: var(--text-muted); pointer-events: none; }
        .dropzone strong { color: var(--primary); pointer-events: none; }
        .dropzone.success strong { color: var(--success); }

        /* Forms */
        .section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 700; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        
        /* Fixed: Flex Wrap to prevent overflow */
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .form-group { flex: 1; display: flex; flex-direction: column; min-width: 100px; } /* Min width prevents collapse */
        
        label { font-size: 0.8rem; font-weight: 500; color: var(--text-main); margin-bottom: 4px; }
        input, select { 
            padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; 
            font-size: 0.9rem; font-family: inherit; transition: border-color 0.2s; width: 100%; box-sizing: border-box;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        
        /* Edit Mode Indicator */
        .edit-indicator {
            display: none; background: #fffbeb; border: 1px solid #fcd34d; color: #92400e;
            padding: 8px; border-radius: 6px; font-size: 0.85rem; margin-bottom: 10px;
            align-items: center; justify-content: space-between;
        }

        /* Buttons */
        .btn { padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-warning { background: var(--warning); color: white; width: 100%; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-main); width: 100%; }
        .btn-secondary:hover { background: #f8fafc; }
        
        .export-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .btn-export { background: white; border: 1px solid var(--border); color: var(--text-muted); font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-export:hover { border-color: var(--primary); color: var(--primary); }

        /* Preview Area */
        .preview-area { flex: 1; padding: 40px; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; }
        .paper { background: white; width: 100%; max-width: 900px; min-height: 800px; padding: 40px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 4px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; padding: 12px 8px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); vertical-align: top; font-size: 0.9rem; }
        tbody tr:hover { background-color: #f8fafc; cursor: pointer; }
        .numeric { text-align: right; font-family: 'Roboto Mono', monospace; }
        .center { text-align: center; }
        .provider-link { color: var(--primary); text-decoration: none; font-size: 0.85rem; word-break: break-all; }
        .note { display: block; font-size: 0.8rem; color: var(--text-muted); margin-top: 2px; font-style: italic; }
        
        .snapshot-mode .delete-col { display: none; }
        .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 20px; }
        .print-logo { height: 60px; width: auto; }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; overflow-y: auto; }
            .sidebar { width: 100%; box-sizing: border-box; }
            .preview-area { padding: 20px; }
            .form-row { flex-direction: column; } /* Full stack on mobile */
        }
    </style>
</head>
<body>

    <div class="navbar">
        <a id="nav-link" href="https://carino.systems" target="_blank" class="brand-link">
            <img id="nav-logo" class="nav-logo" src="https://carino.systems/assets/images/logo.webp" alt="Logo">
            <span id="nav-org-name" class="brand-text" data-i18n="appTitle">General Quotation</span>
        </a>
        <div class="lang-switch" id="lang-container"></div>
    </div>

    <div class="main-container">
        <aside class="sidebar">

            <div>
                <div class="section-title" data-i18n="settingsTitle">Global Settings</div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="targetCurrency">Target Currency</label>
                        <select id="global-currency" class="dynamic-currency"></select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="vatLabel">VAT (%)</label>
                        <input type="number" id="global-vat" value="16">
                    </div>
                </div>
            </div>

            <div>
                <div class="section-title" data-i18n="addItemTitle">Item Details</div>
                
                <div id="edit-indicator" class="edit-indicator">
                    <span data-i18n="editingMode">Editing Item...</span>
                    <button onclick="cancelEdit()" style="background:none;border:none;cursor:pointer;">‚úñ</button>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label data-i18n="catalogLabel">Catalog</label>
                    <select id="catalog-select">
                        <option value="" data-i18n="customItem">-- Custom Item --</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label data-i18n="descLabel">Description</label>
                    <input type="text" id="description">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 70px;">
                        <label data-i18n="qtyLabel">Qty</label>
                        <input type="number" id="quantity" value="1" min="1">
                    </div>
                    <div class="form-group" style="flex: 1.5;">
                        <label data-i18n="priceLabel">Price</label>
                        <input type="number" id="price" step="0.01">
                    </div>
                    <div class="form-group">
                        <label data-i18n="currencyLabel">Currency</label>
                        <select id="item-currency" class="dynamic-currency"></select>
                    </div>
                </div>

                <div style="align-items: center; gap: 8px; margin-bottom: 15px;">
                    <input type="checkbox" id="remove-vat">
                    <label for="remove-vat" data-i18n="stripVatLabel">Price includes VAT (Strip it)</label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="providerLabel">Provider</label>
                        <input type="text" id="provider">
                    </div>
                    <div class="form-group">
                        <label data-i18n="linkLabel">Link</label>
                        <input type="text" id="link">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label data-i18n="notesLabel">Notes</label>
                    <input type="text" id="notes">
                </div>

                <div class="form-row">
                    <button id="btn-add-update" class="btn btn-primary" onclick="handleUpsert()" data-i18n="btnAdd">Add Item</button>
                    <button class="btn btn-secondary" onclick="clearForm()" data-i18n="btnClear">Clear</button>
                </div>
            </div>

            <div>
                <div class="section-title" data-i18n="actionsTitle">Actions & Export</div>
                <div class="export-grid">
                    <button class="btn btn-export" onclick="exportXLSX()"><span>üìä</span> <span data-i18n="btnExcel">Excel</span></button>
                    <button class="btn btn-export" onclick="exportPDF()"><span>üìÑ</span> <span data-i18n="btnPdf">PDF</span></button>
                    <button class="btn btn-export" onclick="exportImage()"><span>üñºÔ∏è</span> <span data-i18n="btnImage">Image</span></button>
                    <button class="btn btn-export" onclick="sendEmail()"><span>üìß</span> <span data-i18n="btnEmail">Email</span></button>
                </div>
            </div>
            
            <div class="dropzone" id="config-dropzone">
                <input type="file" id="config-input" accept=".json" hidden>
                <strong id="dz-title" data-i18n="dropzoneTitle">Load Config</strong>
                <p id="dz-sub" data-i18n="dropzoneSub">Drop JSON here or click</p>
            </div>
            <div><button class="btn btn-secondary" onclick="resetAll()" style="margin-top: 10px; color: var(--danger); border-color: var(--danger);" data-i18n="btnReset">Reset All</button></div>
        </aside>

        <main class="preview-area">
            <div id="paper" class="paper">
                <div class="print-header">
                    <div>
                        <h1 id="print-org-name" style="margin:0; color:var(--primary); font-size: 1.8rem;">General Quotation</h1>
                        <p id="print-date" style="margin:5px 0 0 0; color: var(--text-muted); font-size: 0.9rem;"></p>
                    </div>
                    <img id="print-logo" class="print-logo" style="display:none;" alt="Logo">
                </div>

                <table id="quoteTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;" class="center" data-i18n="thQty">#</th>
                            <th data-i18n="thDesc">Description</th>
                            <th data-i18n="thDetails">Details</th>
                            <th class="numeric" data-i18n="thUnit">Unit Price</th>
                            <th class="numeric" data-i18n="thTotal">Total</th>
                            <th class="delete-col"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot></tfoot>
                </table>
            </div>
        </main>
    </div>

<script>
        // --- 1. DEFAULT EMBEDDED CONFIGURATION ---
        // This acts as your "hardcoded" JSON file.
        const DEFAULT_CONFIG = {
            "organization": {
                "name": "Carino Systems",
                "logo": "https://carino.systems/logo.webp",
                "url": "https://carino.systems"
            },
            "theme": {
                "primary": "#0078d4",
                "background": "#f0f0f0"
            },
            "settings": {
                "defaults": {
                    "currency": "USD",
                    "language": "en"
                },
                "currencies": ["USD", "CAD", "MXN", "JPY"],
                "languages": {
                    "en": "English",
                    "es": "Espa√±ol",
                    "ja": "Êó•Êú¨Ë™û"
                }
            },
            "catalog": [
            // --- CONSULTING & SUPPORT ---
            {
                "description": "General IT Consulting (Hourly)",
                "provider": "Carino Systems",
                "price": 5.00,
                "currency": "USD",
                "note": "General troubleshooting and advisory",
                "vatStripped": true
            },
            {
                "description": "Emergency/After-Hours Support",
                "provider": "Carino Systems",
                "price": 35.00,
                "currency": "USD",
                "note": "Weekends or 8pm-8am response",
                "vatStripped": true
            },
            {
                "description": "Remote Server Health Check",
                "provider": "Carino Systems",
                "price": 5.00,
                "currency": "USD",
                "note": "Log analysis, uptime check, and security patch review. This adds up to general consulting.",
                "vatStripped": true
            },
        
            // --- LICENSING ---
            {
                "description": "RHEL Server - Standard Subscription (1yr)",
                "provider": "Red Hat",
                "link": "https://www.redhat.com/en/store/linux-platforms",
                "price": 80.00,
                "currency": "USD",
                "note": "Self-support, Physical or Virtual Node",
                "vatStripped": false
            },
            {
                "description": "Windows Server 2022 Standard (16 Core)",
                "provider": "Microsoft",
                "price": 800.00,
                "currency": "USD",
                "note": "Base License pack",
                "vatStripped": false
            },
        
            // --- OS INSTALLATION / FORMATTING (Desktop) ---
            {
                "description": "OS Install: Windows 11 Pro (unlicensed)",
                "provider": "Microsoft",
                "price": 25.00,
                "currency": "USD",
                "note": "Includes formatting, driver hunting, updates",
                "vatStripped": true
            },
            {
                "description": "OS License: Windows 11 Pro",
                "provider": "Microsoft",
                "price": 140.00,
                "currency": "USD",
                "note": "License through Microsoft",
                "vatStripped": true
            },
            {
                "description": "OS Install: Fedora Workstation (base install)",
                "provider": "Fedora Project",
                "link": "https://fedoraproject.org/",
                "price": 20.00,
                "currency": "USD",
                "note": "Standard Gnome installation. Quick deploy.",
                "vatStripped": false
            },
            {
                "description": "OS Install: Fedora Workstation (with custom configuration)",
                "provider": "Fedora Project",
                "link": "https://fedoraproject.org/",
                "price": 30.00,
                "currency": "USD",
                "note": "Standard Gnome installation. Quick deploy.",
                "vatStripped": false
            },
            {
                "description": "OS Install: openSUSE Tumbleweed",
                "provider": "openSUSE",
                "link": "https://get.opensuse.org/tumbleweed/",
                "price": 50.00,
                "currency": "USD",
                "note": "Rolling release setup with Btrfs snapshots",
                "vatStripped": false
            },
            {
                "description": "OS Install: Debian Stable",
                "provider": "Debian",
                "price": 50.00,
                "currency": "USD",
                "note": "Rock-solid stability setup",
                "vatStripped": false
            },
            {
                "description": "Advanced Install: Arch Linux",
                "provider": "Arch Linux",
                "link": "https://archlinux.org/",
                "price": 120.00,
                "currency": "USD",
                "note": "Manual CLI install, custom partitioning, DE configuration",
                "vatStripped": false
            },
            {
                "description": "Expert Build: Gentoo Linux",
                "provider": "Gentoo Foundation",
                "link": "https://www.gentoo.org/",
                "price": 180.00,
                "currency": "USD",
                "note": "Kernel compilation & USE flag optimization (24-48h turnaround)",
                "vatStripped": false
            },
        
            // --- ENTERPRISE LINUX DEPLOYMENT ---
            {
                "description": "Server Provisioning: AlmaLinux 9",
                "provider": "AlmaLinux",
                "price": 100.00,
                "currency": "USD",
                "note": "Binary compatible with RHEL. Includes hardening.",
                "vatStripped": true
            },
            {
                "description": "Server Provisioning: Rocky Linux 9",
                "provider": "Rocky Enterprise",
                "price": 100.00,
                "currency": "USD",
                "note": "Community Enterprise OS setup",
                "vatStripped": true
            }
        ]
        };

        const DEFAULT_LANGUAGES = { "en": "EN", "es": "ES", "ja": "JA" };
        const DEFAULT_CURRENCIES = ["USD", "MXN", "CAD", "JPY"];

        // --- 2. STATE ---
        let appState = {
            config: {
                orgName: "General Quotation",
                logo: "https://carino.systems/logo.webp",
                url: "https://carino.systems",
                targetCurrency: "USD",
                vatRate: 16
            },
            theme: { primary: "#2563eb", background: "#f1f5f9" },
            availableLanguages: DEFAULT_LANGUAGES,
            availableCurrencies: DEFAULT_CURRENCIES,
            customDictionary: {},
            catalog: [],
            items: [],
            rates: {},
            editingId: null
        };

        // --- 3. INIT FLOW ---
        document.addEventListener('DOMContentLoaded', async () => {
            // A. Apply Default Config First
            applyConfig(DEFAULT_CONFIG);

            // B. Overwrite with LocalStorage if exists (Persistence)
            loadState();

            // C. Setup System
            initI18n();
            setupUI();
            await fetchRates();
            renderTable();
        });

        // --- 4. CORE FUNCTIONS ---

        // NEW: Reusable function to apply JSON to AppState
        function applyConfig(json) {
            if(json.organization) {
                appState.config.orgName = json.organization.name || appState.config.orgName;
                appState.config.logo = json.organization.logo || null;
                appState.config.url = json.organization.url || "https://carino.systems";
            }
            if(json.theme) appState.theme = json.theme;
            
            if(json.settings) {
                if(json.settings.currencies) appState.availableCurrencies = json.settings.currencies;
                if(json.settings.languages) appState.availableLanguages = json.settings.languages;
                if(json.settings.defaults) {
                    if(json.settings.defaults.currency) appState.config.targetCurrency = json.settings.defaults.currency;
                    // We don't set language here immediately, handled in initI18n
                }
            }
            
            if(json.dictionary) {
                appState.customDictionary = json.dictionary;
            }
            
            if(json.catalog) appState.catalog = json.catalog;
        }

        function loadState() {
            const saved = localStorage.getItem('quoteConfig');
            if (saved) {
                const parsed = JSON.parse(saved);
                // We merge saved state on top of the default config
                appState.config = { ...appState.config, ...parsed.config };
                if(parsed.items && parsed.items.length > 0) appState.items = parsed.items; // Only restore items if they exist
                if(parsed.theme) appState.theme = parsed.theme;
                if(parsed.availableLanguages) appState.availableLanguages = parsed.availableLanguages;
                if(parsed.availableCurrencies) appState.availableCurrencies = parsed.availableCurrencies;
                if(parsed.customDictionary) appState.customDictionary = parsed.customDictionary;
                if(parsed.catalog && parsed.catalog.length > 0) appState.catalog = parsed.catalog;
            }
        }

        function saveState() {
            localStorage.setItem('quoteConfig', JSON.stringify(appState));
        }

        function setupUI() {
            // Colors
            document.documentElement.style.setProperty('--primary', appState.theme.primary);
            document.documentElement.style.setProperty('--bg-body', appState.theme.background);

            // Branding
            const navLink = document.getElementById('nav-link');
            const navLogo = document.getElementById('nav-logo');
            
            if (appState.config.logo) {
                navLogo.src = appState.config.logo;
                document.getElementById('print-logo').src = appState.config.logo;
                document.getElementById('print-logo').style.display = 'block';
            }
            if (appState.config.url) navLink.href = appState.config.url;
            
            document.getElementById('nav-org-name').innerText = appState.config.orgName;
            document.getElementById('print-org-name').innerText = appState.config.orgName;
            document.title = `${appState.config.orgName} - Quote`;

            // Dropzone Logic
            setupDropzone();

            // Language Buttons
            const langContainer = document.getElementById('lang-container');
            langContainer.innerHTML = '';
            Object.entries(appState.availableLanguages).forEach(([code, label]) => {
                const btn = document.createElement('button');
                btn.className = 'lang-btn';
                btn.innerText = label;
                btn.onclick = () => setLang(code);
                if(i18next.language === code) btn.classList.add('active');
                langContainer.appendChild(btn);
            });

            // Currencies
            const currencySelects = document.querySelectorAll('.dynamic-currency');
            currencySelects.forEach(select => {
                const currentVal = select.value || appState.config.targetCurrency;
                select.innerHTML = '';
                appState.availableCurrencies.forEach(curr => {
                    const opt = document.createElement('option');
                    opt.value = curr;
                    opt.innerText = curr;
                    select.appendChild(opt);
                });
                select.value = appState.availableCurrencies.includes(currentVal) ? currentVal : appState.availableCurrencies[0];
            });
            
            document.getElementById('global-vat').value = appState.config.vatRate;
            renderCatalogDropdown();
            
            // Listeners
            document.getElementById('catalog-select').onchange = handleCatalogSelect;
            document.getElementById('global-currency').onchange = (e) => {
                appState.config.targetCurrency = e.target.value;
                fetchRates().then(renderTable);
                saveState();
            };
            document.getElementById('global-vat').oninput = (e) => {
                appState.config.vatRate = parseFloat(e.target.value) || 0;
                renderTable();
                saveState();
            };
        }

        function setupDropzone() {
            const dropzone = document.getElementById('config-dropzone');
            const fileInput = document.getElementById('config-input');
            
            // Visual state check
            if(localStorage.getItem('quoteConfig')) {
                dropzone.classList.add('success');
                document.getElementById('dz-title').innerText = "Config Loaded";
            }

            dropzone.onclick = () => fileInput.click();
            dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('dragover'); };
            dropzone.ondragleave = () => dropzone.classList.remove('dragover');
            dropzone.ondrop = (e) => { e.preventDefault(); dropzone.classList.remove('dragover'); if(e.dataTransfer.files.length) processConfigFile(e.dataTransfer.files[0]); };
            fileInput.onchange = (e) => { if(e.target.files.length) processConfigFile(e.target.files[0]); };
        }

        function processConfigFile(file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const json = JSON.parse(event.target.result);
                    
                    // Use the shared apply function
                    applyConfig(json);

                    // Add Dictionary logic for I18n specifically
                    if(json.dictionary) {
                        Object.keys(json.dictionary).forEach(lang => {
                            i18next.addResourceBundle(lang, 'translation', json.dictionary[lang], true, true);
                        });
                    }

                    saveState();
                    setupUI(); 
                    updateText();
                    
                    // Success Feedback
                    const dz = document.getElementById('config-dropzone');
                    dz.classList.add('success');
                    document.getElementById('dz-title').innerText = "Config Loaded";
                    
                } catch (err) {
                    alert("Invalid JSON file");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        // --- CATALOG & ITEMS ---
        function handleCatalogSelect(e) {
            const idx = e.target.value;
            if (idx === "") return;
            const item = appState.catalog[idx];
            document.getElementById('description').value = item.description || "";
            document.getElementById('price').value = item.price || "";
            document.getElementById('quantity').value = 1;
            document.getElementById('item-currency').value = item.currency || "USD";
            document.getElementById('provider').value = item.provider || "";
            document.getElementById('link').value = item.link || "";
            document.getElementById('notes').value = item.note || "";
            document.getElementById('remove-vat').checked = item.vatStripped || false;
        }

        function renderCatalogDropdown() {
            const select = document.getElementById('catalog-select');
            select.innerHTML = `<option value="">-- ${i18next.t('customItem')} --</option>`;
            appState.catalog.forEach((item, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.innerText = item.description;
                select.appendChild(opt);
            });
        }

        function handleUpsert() {
            const desc = document.getElementById('description').value;
            const price = parseFloat(document.getElementById('price').value);
            const qty = parseFloat(document.getElementById('quantity').value) || 1;

            if (!desc || isNaN(price)) return alert(i18next.t('validationError'));

            const itemData = {
                id: appState.editingId || Date.now(),
                desc, price, qty,
                currency: document.getElementById('item-currency').value,
                provider: document.getElementById('provider').value,
                link: document.getElementById('link').value,
                note: document.getElementById('notes').value,
                stripVat: document.getElementById('remove-vat').checked
            };

            if (appState.editingId) {
                const index = appState.items.findIndex(i => i.id === appState.editingId);
                if (index !== -1) appState.items[index] = itemData;
                cancelEdit();
            } else {
                appState.items.push(itemData);
                clearForm();
            }
            saveState();
            renderTable();
        }

        function loadItemForEdit(id) {
            const item = appState.items.find(i => i.id === id);
            if(!item) return;
            appState.editingId = id;
            document.getElementById('description').value = item.desc;
            document.getElementById('price').value = item.price;
            document.getElementById('quantity').value = item.qty || 1;
            document.getElementById('item-currency').value = item.currency;
            document.getElementById('provider').value = item.provider;
            document.getElementById('link').value = item.link;
            document.getElementById('notes').value = item.note;
            document.getElementById('remove-vat').checked = item.stripVat;

            document.getElementById('edit-indicator').style.display = 'flex';
            const btn = document.getElementById('btn-add-update');
            btn.innerText = i18next.t('btnUpdate');
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-warning');
        }

        function cancelEdit() {
            appState.editingId = null;
            clearForm();
            document.getElementById('edit-indicator').style.display = 'none';
            const btn = document.getElementById('btn-add-update');
            btn.innerText = i18next.t('btnAdd');
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-primary');
        }

        function deleteItem(id, event) {
            event.stopPropagation();
            if(confirm(i18next.t('confirmReset') + "?")) { // Reusing reset text for delete
                appState.items = appState.items.filter(i => i.id !== id);
                if(appState.editingId === id) cancelEdit();
                saveState();
                renderTable();
            }
        }

        function clearForm() {
            document.getElementById('catalog-select').value = "";
            document.getElementById('description').value = "";
            document.getElementById('price').value = "";
            document.getElementById('quantity').value = 1;
            document.getElementById('provider').value = "";
            document.getElementById('link').value = "";
            document.getElementById('notes').value = "";
            document.getElementById('remove-vat').checked = false;
        }

        function resetAll() {
            if(confirm(i18next.t('confirmReset'))) {
                localStorage.removeItem('quoteConfig');
                location.reload();
            }
        }

        // --- MATH & RENDER ---
        async function fetchRates() {
            const base = appState.config.targetCurrency;
            try {
                const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
                const data = await res.json();
                appState.rates = data.rates;
            } catch (e) {}
        }

        function getRate(from, to) {
            if (from === to) return 1;
            const r = appState.rates[from];
            return r ? (1/r) : 1;
        }

        function renderTable() {
            const tbody = document.querySelector('#quoteTable tbody');
            const tfoot = document.querySelector('#quoteTable tfoot');
            tbody.innerHTML = '';
            
            const targetCurr = appState.config.targetCurrency;
            const vatPct = appState.config.vatRate;
            let total = 0;

            appState.items.forEach(item => {
                const qty = item.qty || 1;
                const rate = getRate(item.currency, targetCurr);
                let base = item.stripVat ? item.price / (1 + (vatPct/100)) : item.price;
                const unitConverted = base * rate;
                const final = (unitConverted * qty) * (1 + (vatPct/100));
                total += final;

                const tr = document.createElement('tr');
                tr.onclick = () => loadItemForEdit(item.id);
                tr.innerHTML = `
                    <td class="center" style="font-weight:600;">${qty}</td>
                    <td><strong>${item.desc}</strong>${item.note ? `<span class="note">${item.note}</span>` : ''}</td>
                    <td>
                        <div>${item.provider || '-'}</div>
                        ${item.link ? `<a href="${item.link}" target="_blank" class="provider-link" onclick="event.stopPropagation()">Link ‚Üó</a>` : ''}
                    </td>
                    <td class="numeric">
                        ${item.price.toFixed(2)} ${item.currency}
                        <div style="font-size:0.75em; color:#999;">~ ${unitConverted.toFixed(2)} ${targetCurr}</div>
                    </td>
                    <td class="numeric"><strong>${final.toFixed(2)} ${targetCurr}</strong></td>
                    <td class="delete-col">
                        <button onclick="deleteItem(${item.id}, event)" style="color:var(--danger); background:none; border:none; cursor:pointer; font-size:1.2em;">&times;</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            tfoot.innerHTML = `
                <tr style="background:#f8fafc; font-weight:bold; border-top:2px solid var(--border);">
                    <td colspan="4" style="text-align:right;">${i18next.t('totalIncVat')}</td>
                    <td class="numeric" style="font-size:1.1em; color:var(--primary);">${total.toFixed(2)} ${targetCurr}</td>
                    <td></td>
                </tr>
            `;

            document.getElementById('print-date').innerText = new Date().toLocaleDateString();
        }

        // --- EXPORTS ---
        function exportXLSX() {
            const targetCurr = appState.config.targetCurrency;
            const vatPct = appState.config.vatRate;
            
            const data = appState.items.map(i => {
                const qty = i.qty || 1;
                const rate = getRate(i.currency, targetCurr);
                let base = i.stripVat ? i.price / (1 + (vatPct/100)) : i.price;
                const final = (base * rate * qty) * (1 + (vatPct/100));
                return {
                    [i18next.t('thQty')]: qty,
                    [i18next.t('thDesc')]: i.desc,
                    [i18next.t('providerLabel')]: i.provider,
                    "URL": i.link,
                    [i18next.t('priceLabel')]: i.price,
                    [i18next.t('currencyLabel')]: i.currency,
                    [`${i18next.t('thTotal')} (${targetCurr})`]: final
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Quote");
            XLSX.writeFile(wb, `${appState.config.orgName}_Quote.xlsx`);
        }

        function exportImage() {
            const el = document.getElementById('paper');
            el.classList.add('snapshot-mode');
            html2canvas(el, { useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'quote.png';
                link.href = canvas.toDataURL();
                link.click();
                el.classList.remove('snapshot-mode');
            });
        }

        async function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let fontUsed = "helvetica";
            try {
                // Noto Sans JP TTF (High reliability)
                const fontRes = await fetch('https://unpkg.com/@fontsource/noto-sans-jp@5.0.12/files/noto-sans-jp-all-400-normal.woff');
                if(fontRes.ok) {
                    const fontBuf = await fontRes.arrayBuffer();
                    doc.addFileToVFS("NotoSansJP.ttf", new Uint8Array(fontBuf));
                    doc.addFont("NotoSansJP.ttf", "NotoSansJP", "normal");
                    fontUsed = "NotoSansJP";
                }
            } catch(e) { console.warn("Font load failed, fallback to Helvetica"); }

            const targetCurr = appState.config.targetCurrency;
            const vatPct = appState.config.vatRate;
            
            doc.setFont(fontUsed);
            doc.setFontSize(16);
            doc.text(appState.config.orgName, 14, 20);
            doc.setFontSize(10);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 28);
            
            if (appState.config.logo && appState.config.logo.startsWith('data:image')) {
                try { doc.addImage(appState.config.logo, 'PNG', 160, 10, 30, 0); } catch(e){}
            }

            const body = appState.items.map(i => {
                const qty = i.qty || 1;
                const rate = getRate(i.currency, targetCurr);
                let base = i.stripVat ? i.price / (1 + (vatPct/100)) : i.price;
                const final = (base * rate * qty) * (1 + (vatPct/100));
                return [qty, i.desc, i.provider, i.link, `${i.price} ${i.currency}`, final.toFixed(2)];
            });

            doc.autoTable({
                head: [[i18next.t('thQty'), i18next.t('thDesc'), i18next.t('providerLabel'), "Link", i18next.t('thUnit'), `${i18next.t('thTotal')} (${targetCurr})`]],
                body: body,
                startY: 35,
                styles: { font: fontUsed, fontSize: 9, overflow: 'linebreak' },
                columnStyles: { 3: { textColor: [0,0,255] } },
                didDrawCell: (d) => {
                    if (d.column.index === 3 && d.cell.raw && d.section === 'body') {
                        doc.link(d.cell.x, d.cell.y, d.cell.width, d.cell.height, { url: d.cell.raw });
                    }
                }
            });
            doc.save('quote.pdf');
        }

        function sendEmail() {
            const targetCurr = appState.config.targetCurrency;
            const vatPct = appState.config.vatRate;
            let body = `${i18next.t('emailHeader')}\n\n`;
            let total = 0;
            
            appState.items.forEach(i => {
                const qty = i.qty || 1;
                const rate = getRate(i.currency, targetCurr);
                let base = i.stripVat ? i.price / (1 + (vatPct/100)) : i.price;
                const final = (base * rate * qty) * (1 + (vatPct/100));
                total += final;
                
                const qtyStr = qty > 1 ? `${qty}x ` : '';
                body += `‚Ä¢ ${qtyStr}${i.desc} (${i.provider}): ${final.toFixed(2)} ${targetCurr}\n`;
                if(i.link) body += `  ${i.link}\n`;
            });
            
            body += `\n${i18next.t('totalIncVat')}: ${total.toFixed(2)} ${targetCurr}`;
            const subject = `${appState.config.orgName} - Quote`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // --- I18N ---
        function setLang(code) {
            i18next.changeLanguage(code, () => {
                updateText();
                renderTable();
                setupUI();
            });
        }

        function initI18n() {
            const resources = {
                en: { translation: {
                    appTitle: "General Quotation", dropzoneTitle: "Load Config", dropzoneSub: "Drop JSON here or click",
                    settingsTitle: "Global Settings", targetCurrency: "Target Currency", vatLabel: "VAT (%)",
                    addItemTitle: "Item Details", catalogLabel: "Catalog", customItem: "Custom Item",
                    descLabel: "Description", priceLabel: "Price", currencyLabel: "Currency", providerLabel: "Provider", linkLabel: "Link", notesLabel: "Notes", stripVatLabel: "Price includes VAT (Strip it)", qtyLabel: "Qty",
                    btnAdd: "Add Item", btnUpdate: "Update Item", btnClear: "Clear", actionsTitle: "Actions & Export",
                    btnExcel: "Excel", btnPdf: "PDF", btnImage: "Image", btnEmail: "Email", btnReset: "Reset All",
                    thQty: "#", thDesc: "Description", thDetails: "Details", thUnit: "Unit Price", thTotal: "Total", totalIncVat: "TOTAL (Inc. VAT)",
                    configLoaded: "Configuration Loaded Successfully!", validationError: "Description and Price are required", confirmReset: "Delete all data?", emailHeader: "Here is the quotation summary:", editingMode: "Editing Item"
                }},
                es: { translation: {
                    appTitle: "Cotizaci√≥n General", dropzoneTitle: "Cargar Config", dropzoneSub: "Arrastra JSON aqu√≠ o clic",
                    settingsTitle: "Configuraci√≥n Global", targetCurrency: "Moneda Destino", vatLabel: "IVA (%)",
                    addItemTitle: "Detalles del √çtem", catalogLabel: "Cat√°logo", customItem: "√çtem Personalizado",
                    descLabel: "Descripci√≥n", priceLabel: "Precio", currencyLabel: "Moneda", providerLabel: "Proveedor", linkLabel: "Enlace", notesLabel: "Notas", stripVatLabel: "El precio incluye IVA (Desglosar)", qtyLabel: "Cant",
                    btnAdd: "Agregar", btnUpdate: "Actualizar", btnClear: "Limpiar", actionsTitle: "Acciones y Exportar",
                    btnExcel: "Excel", btnPdf: "PDF", btnImage: "Imagen", btnEmail: "Correo", btnReset: "Reiniciar",
                    thQty: "#", thDesc: "Descripci√≥n", thDetails: "Detalles", thUnit: "Precio Unit.", thTotal: "Total", totalIncVat: "TOTAL (Con IVA)",
                    configLoaded: "¬°Configuraci√≥n cargada!", validationError: "Descripci√≥n y Precio son requeridos", confirmReset: "¬øBorrar todos los datos?", emailHeader: "Aqu√≠ est√° el resumen:", editingMode: "Editando..."
                }},
                ja: { translation: {
                    appTitle: "‰∏ÄËà¨Ë¶ãÁ©ç", dropzoneTitle: "Ë®≠ÂÆö„Çí„É≠„Éº„Éâ", dropzoneSub: "JSON„Çí„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ",
                    settingsTitle: "ÂÖ®‰ΩìË®≠ÂÆö", targetCurrency: "Ë¶ãÁ©çÈÄöË≤®", vatLabel: "Ê∂àË≤ªÁ®é (%)",
                    addItemTitle: "„Ç¢„Ç§„ÉÜ„É†Ë©≥Á¥∞", catalogLabel: "„Ç´„Çø„É≠„Ç∞", customItem: "„Ç´„Çπ„Çø„É†„Ç¢„Ç§„ÉÜ„É†",
                    descLabel: "Ë™¨Êòé", priceLabel: "‰æ°Ê†º", currencyLabel: "ÈÄöË≤®", providerLabel: "„Éó„É≠„Éê„Ç§„ÉÄ„Éº", linkLabel: "„É™„É≥„ÇØ", notesLabel: "ÂÇôËÄÉ", stripVatLabel: "Á®éËæº‰æ°Ê†º (Á®é„ÇíÊäú„Åè)", qtyLabel: "Êï∞Èáè",
                    btnAdd: "ËøΩÂä†", btnUpdate: "Êõ¥Êñ∞", btnClear: "„ÇØ„É™„Ç¢", actionsTitle: "Êìç‰Ωú„Å®„Ç®„ÇØ„Çπ„Éù„Éº„Éà",
                    btnExcel: "Excel", btnPdf: "PDF", btnImage: "ÁîªÂÉè", btnEmail: "„É°„Éº„É´", btnReset: "„É™„Çª„ÉÉ„Éà",
                    thQty: "Êï∞", thDesc: "Ë™¨Êòé", thDetails: "Ë©≥Á¥∞", thUnit: "Âçò‰æ°", thTotal: "ÂêàË®à", totalIncVat: "ÂêàË®à (Á®éËæº)",
                    configLoaded: "Ë®≠ÂÆö„Åå„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü", validationError: "Ë™¨Êòé„Å®‰æ°Ê†º„ÅØÂøÖÈ†à„Åß„Åô", confirmReset: "„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", emailHeader: "Ë¶ãÁ©ç„ÇÇ„ÇäÊ¶ÇË¶Å:", editingMode: "Á∑®ÈõÜ‰∏≠"
                }}
            };
            
            // Add custom dictionary logic
            if(appState.customDictionary) {
                Object.keys(appState.customDictionary).forEach(lang => {
                    if(resources[lang]) Object.assign(resources[lang].translation, appState.customDictionary[lang]);
                    else resources[lang] = { translation: appState.customDictionary[lang] };
                });
            }
            
            i18next.use(i18nextBrowserLanguageDetector).init({ fallbackLng: 'en', resources: resources }, () => updateText());
        }

        function updateText() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = i18next.t(el.getAttribute('data-i18n'));
            });
            document.getElementById('description').placeholder = i18next.t('descLabel');
            document.getElementById('notes').placeholder = i18next.t('notesLabel');
        }
    </script>
</body>
</html>